# ğŸ“Š Diagramas Detallados: Session & Auth Stabilization

**VersiÃ³n:** 1.0  
**Fecha:** 2024-12-19  
**Complementa:** `AI-SPEC-SESSION-AUTH-STABILIZATION.md`

---

## 1. Diagrama de Secuencia: Bootstrap Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser â”‚    â”‚  AppLayout   â”‚    â”‚AuthMgr   â”‚    â”‚ ApiClientâ”‚    â”‚  Backend â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚ 1. Page Load    â”‚                  â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚ 2. bootstrap()   â”‚              â”‚              â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 3. Check Cacheâ”‚              â”‚
     â”‚                  â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 4. Cache Hit?â”‚              â”‚
     â”‚                  â”‚                  â”‚    NO         â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 5. Acquire    â”‚              â”‚
     â”‚                  â”‚                  â”‚    Mutex      â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 6. Double     â”‚              â”‚
     â”‚                  â”‚                  â”‚    Check      â”‚              â”‚
     â”‚                  â”‚                  â”‚    Cache      â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 7. GET        â”‚              â”‚
     â”‚                  â”‚                  â”‚    /session/meâ”‚              â”‚
     â”‚                  â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚ 8. GET       â”‚
     â”‚                  â”‚                  â”‚              â”‚ /session/me  â”‚
     â”‚                  â”‚                  â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚ 9. Query DB
     â”‚                  â”‚                  â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  â”‚                  â”‚              â”‚              â”‚           â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚ 10. Returnâ”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚ 11. 200 OK   â”‚
     â”‚                  â”‚                  â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 12. Response â”‚              â”‚
     â”‚                  â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 13. Update    â”‚              â”‚
     â”‚                  â”‚                  â”‚    Cache      â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 14. Notify    â”‚              â”‚
     â”‚                  â”‚                  â”‚    Subscribersâ”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚ 15. State       â”‚              â”‚              â”‚
     â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚ 16. Render       â”‚                  â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚              â”‚              â”‚
```

**Tiempo total estimado:** <200ms (con cache: <10ms)

---

## 2. Diagrama de Secuencia: Refresh Token Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Component â”‚    â”‚ ApiClient    â”‚    â”‚AuthMgr   â”‚    â”‚  Backend â”‚    â”‚  Backend â”‚
â”‚          â”‚    â”‚              â”‚    â”‚          â”‚    â”‚ /session â”‚    â”‚ /refresh â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚ 1. GET /agents   â”‚                  â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚ 2. GET /agents   â”‚              â”‚              â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚ 3. 401       â”‚
     â”‚                  â”‚                  â”‚              â”‚ Unauthorized â”‚
     â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚ 4. refreshToken()â”‚              â”‚              â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 5. Check     â”‚              â”‚
     â”‚                  â”‚                  â”‚    Cooldown  â”‚              â”‚
     â”‚                  â”‚                  â”‚    (60s)     â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 6. Check     â”‚              â”‚
     â”‚                  â”‚                  â”‚    Mutex     â”‚              â”‚
     â”‚                  â”‚                  â”‚    (isRefreshing)â”‚          â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 7. POST       â”‚              â”‚
     â”‚                  â”‚                  â”‚    /auth/refreshâ”‚            â”‚
     â”‚                  â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚ 8. Validate
     â”‚                  â”‚                  â”‚              â”‚              â”‚    Refresh Token
     â”‚                  â”‚                  â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  â”‚                  â”‚              â”‚              â”‚           â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚ 9. Generate
     â”‚                  â”‚                  â”‚              â”‚              â”‚    New Tokens
     â”‚                  â”‚                  â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚ 10. 200 OK   â”‚
     â”‚                  â”‚                  â”‚              â”‚    + Cookies â”‚
     â”‚                  â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 11. Invalidateâ”‚              â”‚
     â”‚                  â”‚                  â”‚    Cache      â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚ 12. Return   â”‚              â”‚
     â”‚                  â”‚                  â”‚    true       â”‚              â”‚
     â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚ 13. Retry       â”‚              â”‚              â”‚
     â”‚                  â”‚    GET /agents  â”‚              â”‚              â”‚
     â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚                  â”‚                  â”‚              â”‚ 14. 200 OK   â”‚
     â”‚                  â”‚                  â”‚              â”‚    + Data    â”‚
     â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚                  â”‚                  â”‚              â”‚              â”‚
     â”‚ 15. Response     â”‚                  â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚              â”‚              â”‚
```

**Tiempo total estimado:** <500ms (refresh + retry)

---

## 3. Diagrama de Estados: Auth State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  UNKNOWN    â”‚ (Estado inicial)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ bootstrap()
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ BOOTSTRAPINGâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ AUTHENTICATEDâ”‚      â”‚UNAUTHENTICATEDâ”‚
         â”‚              â”‚      â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
                â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   VALIDATING â”‚      â”‚   LOGGING OUTâ”‚
         â”‚  (cada 5 min)â”‚      â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”              â”‚
         â”‚             â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”‚
    â”‚AUTHENTICâ”‚  â”‚UNAUTHENTICâ”‚        â”‚
    â”‚ATED     â”‚  â”‚ATED       â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                      â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚UNAUTHENTICATEDâ”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Transiciones:**
- `UNKNOWN â†’ BOOTSTRAPING`: Al mount de la app
- `BOOTSTRAPING â†’ AUTHENTICATED`: Si `/session/me` retorna 200
- `BOOTSTRAPING â†’ UNAUTHENTICATED`: Si `/session/me` retorna 401/403
- `AUTHENTICATED â†’ VALIDATING`: Cada 5 minutos (silencioso)
- `VALIDATING â†’ AUTHENTICATED`: Si validaciÃ³n exitosa
- `VALIDATING â†’ UNAUTHENTICATED`: Si validaciÃ³n falla
- `AUTHENTICATED â†’ UNAUTHENTICATED`: Si refresh falla o logout explÃ­cito

---

## 4. Diagrama de Componentes: Arquitectura Completa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (Next.js)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              AuthManager (Singleton)                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚   Mutex      â”‚  â”‚    Cache     â”‚  â”‚   Events     â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ (single-     â”‚  â”‚  (5 min TTL) â”‚  â”‚  (emitter)   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  flight)     â”‚  â”‚              â”‚  â”‚              â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Methods:                                                 â”‚  â”‚
â”‚  â”‚  - bootstrap()                                            â”‚  â”‚
â”‚  â”‚  - validate()                                             â”‚  â”‚
â”‚  â”‚  - refreshToken()                                         â”‚  â”‚
â”‚  â”‚  - logout()                                               â”‚  â”‚
â”‚  â”‚  - getState()                                             â”‚  â”‚
â”‚  â”‚  - subscribe()                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ uses                                    â”‚
â”‚                        â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ApiClient (Refactorizado)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚   Request    â”‚  â”‚    Error     â”‚  â”‚    Retry     â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ Interceptor   â”‚  â”‚   Handler    â”‚  â”‚  (backoff)   â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  - Manejo diferenciado 401/403/429                       â”‚  â”‚
â”‚  â”‚  - Backoff exponencial                                   â”‚  â”‚
â”‚  â”‚  - Rate limit handling                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ subscribes to                          â”‚
â”‚                        â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Components (Simplificados)                   â”‚  â”‚
â”‚  â”‚  - AppLayout                                              â”‚  â”‚
â”‚  â”‚  - AppPage                                                â”‚  â”‚
â”‚  â”‚  - AgentsPage                                            â”‚  â”‚
â”‚  â”‚  - AppointmentsPage                                      â”‚  â”‚
â”‚  â”‚  - SettingsPages                                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Pattern:                                                 â”‚  â”‚
â”‚  â”‚  const state = AuthManager.getState()                    â”‚  â”‚
â”‚  â”‚  // usar state.user, state.tenant                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP (cookies HttpOnly)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROXY (Next.js API Route)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - Forward requests                                              â”‚
â”‚  - Preserve headers (x-tenant-id)                                â”‚
â”‚  - No auth logic                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (NestJS)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ SessionController    â”‚  â”‚ AuthController       â”‚            â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚            â”‚
â”‚  â”‚ - GET /session/me   â”‚  â”‚ - POST /auth/refresh â”‚            â”‚
â”‚  â”‚ - Cache (5 min)      â”‚  â”‚ - Rate limiting      â”‚            â”‚
â”‚  â”‚ - Invalidation       â”‚  â”‚ - Token validation   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Guards                                  â”‚  â”‚
â”‚  â”‚  - JwtAuthGuard (verifica token)                          â”‚  â”‚
â”‚  â”‚  - TenantContextGuard (establece tenant)                   â”‚  â”‚
â”‚  â”‚  - RbacGuard (verifica permisos)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Database (Prisma)                      â”‚  â”‚
â”‚  â”‚  - User                                                   â”‚  â”‚
â”‚  â”‚  - Tenant                                                 â”‚  â”‚
â”‚  â”‚  - TenantMembership                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Diagrama de Flujo: Manejo de Errores

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Request   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Response  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  200 OK â”‚      â”‚  401    â”‚      â”‚  403    â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚                 â”‚
        â”‚                â”‚                 â”‚
        â”‚                â–¼                 â”‚
        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
        â”‚         â”‚ Token        â”‚         â”‚
        â”‚         â”‚ Expirado?    â”‚         â”‚
        â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
        â”‚                â”‚                 â”‚
        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”‚
        â”‚         â”‚              â”‚         â”‚
        â”‚         â–¼              â–¼         â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚    â”‚  YES    â”‚   â”‚   NO    â”‚     â”‚
        â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚
        â”‚         â”‚              â”‚         â”‚
        â”‚         â”‚              â”‚         â”‚
        â”‚         â–¼              â–¼         â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚    â”‚ Refresh â”‚   â”‚ Logout  â”‚     â”‚
        â”‚    â”‚ Token   â”‚   â”‚         â”‚     â”‚
        â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚         â”‚              â”‚         â”‚
        â”‚         â”‚              â”‚         â”‚
        â”‚         â–¼              â”‚         â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”‚
        â”‚    â”‚ Retry   â”‚         â”‚         â”‚
        â”‚    â”‚ Request â”‚         â”‚         â”‚
        â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚         â”‚
        â”‚         â”‚              â”‚         â”‚
        â”‚         â”‚              â”‚         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚              â”‚
                  â–¼              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Success â”‚   â”‚  Error   â”‚
            â”‚         â”‚   â”‚ (show   â”‚
            â”‚         â”‚   â”‚ message)â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Diagrama de Timing: Performance Optimization

```
Timeline (ms):
0    50   100  150  200  250  300  350  400
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”‚ Bootstrap Start                          â”‚
â”‚    â”‚                                     â”‚
â”‚    â”œâ”€ Check Cache (1ms)                 â”‚
â”‚    â”‚                                     â”‚
â”‚    â”œâ”€ Acquire Mutex (2ms)                â”‚
â”‚    â”‚                                     â”‚
â”‚    â”œâ”€ Double Check Cache (1ms)           â”‚
â”‚    â”‚                                     â”‚
â”‚    â”œâ”€ HTTP Request (150ms) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    â”‚    â”‚                                 â”‚
â”‚    â”‚    â”œâ”€ Network (50ms)                â”‚
â”‚    â”‚    â”œâ”€ Backend Processing (80ms)     â”‚
â”‚    â”‚    â””â”€ Response (20ms)               â”‚
â”‚    â”‚                                     â”‚
â”‚    â”œâ”€ Update Cache (1ms)                 â”‚
â”‚    â”‚                                     â”‚
â”‚    â””â”€ Notify Subscribers (5ms)            â”‚
â”‚                                          â”‚
â”‚ Total: ~160ms (P95)                      â”‚
â”‚ Target: <200ms âœ…                        â”‚
```

**Con Cache Hit:**
```
0    5    10
â”‚    â”‚    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚    â”‚    â”‚
â”‚ Bootstrap Start                          â”‚
â”‚    â”‚                                     â”‚
â”‚    â”œâ”€ Check Cache (1ms)                  â”‚
â”‚    â”‚    â”‚                                 â”‚
â”‚    â”‚    â””â”€ Cache Hit!                     â”‚
â”‚    â”‚                                     â”‚
â”‚    â””â”€ Return State (1ms)                â”‚
â”‚                                          â”‚
â”‚ Total: ~2ms âœ…                          â”‚
```

---

## 7. Diagrama de Concurrencia: Single-Flight Pattern

```
Time â†’
â”‚
â”‚ Request 1: bootstrap() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚
â”‚ Request 2: bootstrap() â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                               â”‚      â”‚
â”‚ Request 3: bootstrap() â”€â”€â”   â”‚      â”‚
â”‚                          â”‚   â”‚      â”‚
â”‚                          â–¼   â–¼      â–¼
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â”‚   Mutex Queue   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                             â”‚
â”‚                             â”‚ (solo 1 ejecuta)
â”‚                             â–¼
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â”‚  HTTP Request   â”‚
â”‚                    â”‚  (single call)  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                             â”‚
â”‚                             â”‚ (todos reciben)
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â”‚                 â”‚
â”‚                    â–¼                 â–¼
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            â”‚  Request 1   â”‚   â”‚  Request 2   â”‚
â”‚            â”‚  (result)    â”‚   â”‚  (result)    â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            â”‚  Request 3   â”‚
â”‚            â”‚  (result)    â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Resultado:** 3 llamadas a `bootstrap()`, pero solo 1 HTTP request.

---

## 8. Diagrama de Cache: Estrategia Multi-Nivel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cache Strategy                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Request â†’ L1 Cache (Memory) â”€â”€â”                        â”‚
â”‚            â”‚                    â”‚                        â”‚
â”‚            â”œâ”€ Hit? â”€â”€YESâ”€â”€> Return (2ms)                â”‚
â”‚            â”‚                    â”‚                        â”‚
â”‚            â””â”€ NO                â”‚                        â”‚
â”‚                                 â”‚                        â”‚
â”‚            L2 Cache (Backend) â”€â”€â”                        â”‚
â”‚            â”‚                    â”‚                        â”‚
â”‚            â”œâ”€ Hit? â”€â”€YESâ”€â”€> Return (50ms)                â”‚
â”‚            â”‚                    â”‚                        â”‚
â”‚            â””â”€ NO                â”‚                        â”‚
â”‚                                 â”‚                        â”‚
â”‚            Database Query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚            â”‚                                              â”‚
â”‚            â””â”€> Return (150ms)                            â”‚
â”‚                                                           â”‚
â”‚  TTL:                                                      â”‚
â”‚  - L1: 5 minutos                                          â”‚
â”‚  - L2: 5 minutos                                          â”‚
â”‚                                                           â”‚
â”‚  Invalidation:                                             â”‚
â”‚  - Logout                                                  â”‚
â”‚  - Token refresh                                           â”‚
â”‚  - User data change                                        â”‚
â”‚  - Tenant change                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Diagrama de MigraciÃ³n: Antes vs DespuÃ©s

### ANTES (ProblemÃ¡tico)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AppLayout   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€> checkAuth() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                         â”‚
       â””â”€> getCurrentUserWithRole() â”€â”€â”
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ AppPage     â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                             â”‚
       â”œâ”€> checkAuth() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                             â”‚
       â””â”€> getCurrentUserWithRole() â”€â”¤
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ AgentsPage  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                             â”‚
       â”œâ”€> checkAuth() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                             â”‚
       â””â”€> getCurrentUserWithRole() â”€â”¤
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ 3-5 HTTP Calls  â”‚
                            â”‚  to /session/me â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DESPUÃ‰S (Optimizado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AppLayout   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€> AuthManager.bootstrap() â”€â”€â”
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ AppPage     â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                             â”‚
       â””â”€> AuthManager.getState() â”€â”€â”€â”¤
       â”‚    (sÃ­ncrono, desde cache)   â”‚
       â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ AgentsPage  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                             â”‚
       â””â”€> AuthManager.getState() â”€â”€â”€â”¤
       â”‚    (sÃ­ncrono, desde cache)   â”‚
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ 1 HTTP Call     â”‚
                            â”‚  to /session/me â”‚
                            â”‚  (single-flight)â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Diagrama de Errores: Matriz de DecisiÃ³n

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Error     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  401    â”‚      â”‚  403    â”‚      â”‚  429    â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Refresh â”‚      â”‚ Show    â”‚      â”‚ Activateâ”‚
   â”‚ Token   â”‚      â”‚ Error   â”‚      â”‚ Cooldownâ”‚
   â”‚ (1x)    â”‚      â”‚ (NO     â”‚      â”‚ Use     â”‚
   â”‚         â”‚      â”‚ logout) â”‚      â”‚ Cache   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€ Success â”€â”€> Retry Request
        â”‚
        â””â”€ Fail â”€â”€> Logout
```

---

## 11. Diagrama de React StrictMode: SoluciÃ³n

### PROBLEMA (StrictMode ejecuta 2x)

```
Mount 1: useEffect(() => checkAuth()) â”€â”€â”
                                        â”‚
Mount 2: useEffect(() => checkAuth()) â”€â”¤ (StrictMode)
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ 2 HTTP Calls   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SOLUCIÃ“N (AuthManager maneja duplicados)

```
Mount 1: useEffect(() => authManager.bootstrap()) â”€â”€â”
                                                      â”‚
Mount 2: useEffect(() => authManager.bootstrap()) â”€â”€â”€â”¤
                                                      â”‚
                                                      â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚  bootstrap()    â”‚
                                        â”‚  Promise Cache  â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ 1 HTTP Call     â”‚
                                        â”‚  (ambos reciben)â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. Diagrama de ValidaciÃ³n PeriÃ³dica

```
Time (minutos):
0    5    10   15   20   25   30
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”‚ Bootstrap (1x)              â”‚
â”‚    â”‚                         â”‚
â”‚    â”œâ”€> Cache vÃ¡lido (5 min) â”‚
â”‚    â”‚                         â”‚
â”‚    â”‚    â”‚                    â”‚
â”‚    â”‚    â”œâ”€> Validate (silent)â”‚
â”‚    â”‚    â”‚   (no bloquea UI)  â”‚
â”‚    â”‚    â”‚                    â”‚
â”‚    â”‚    â”‚    â”‚                â”‚
â”‚    â”‚    â”‚    â”œâ”€> Validate    â”‚
â”‚    â”‚    â”‚    â”‚                â”‚
â”‚    â”‚    â”‚    â”‚    â”‚            â”‚
â”‚    â”‚    â”‚    â”‚    â”œâ”€> Validateâ”‚
â”‚    â”‚    â”‚    â”‚    â”‚            â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚        â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â”œâ”€> ... â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚        â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”œâ”€> ...â”‚
```

**CaracterÃ­sticas:**
- Bootstrap: 1 vez al inicio
- Validate: Cada 5 minutos (silencioso)
- No bloquea UI
- Solo actualiza cache si hay cambios

---

## 13. Diagrama de Logout Coordinado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚
â”‚  (click)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Component  â”‚
â”‚  logout()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthManagerâ”‚
â”‚ .logout()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€> POST /auth/logout
       â”‚
       â”œâ”€> Invalidate Cache L1
       â”‚
       â”œâ”€> Invalidate Cache L2
       â”‚
       â”œâ”€> Clear SessionStorage
       â”‚
       â”œâ”€> Clear LocalStorage
       â”‚
       â”œâ”€> Notify Subscribers
       â”‚
       â””â”€> router.push('/login')
```

**Resultado:** Logout coordinado, todos los componentes se actualizan.

---

## 14. Diagrama de Multi-Tab Synchronization

```
Tab 1                    Tab 2                    Tab 3
â”‚                        â”‚                        â”‚
â”‚ bootstrap()            â”‚ bootstrap()            â”‚ bootstrap()
â”‚                        â”‚                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                        â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ State: AUTHENTICATED   â”‚ State: AUTHENTICATED   â”‚ State: AUTHENTICATED
â”‚                        â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ User clicks logout     â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                        â”‚                        â”‚
â”‚ POST /auth/logout      â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                        â”‚                        â”‚
â”‚ AuthManager.logout()   â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                        â”‚                        â”‚
â”‚ Notify Subscribers     â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                        â”‚                        â”‚
â”‚ State: UNAUTHENTICATED â”‚ State: UNAUTHENTICATED â”‚ State: UNAUTHENTICATED
â”‚                        â”‚                        â”‚
â”‚ router.push('/login')â”‚                        â”‚
â”‚                        â”‚                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                        â”‚                        â”‚
â”‚ All tabs redirect      â”‚                        â”‚
â”‚ to /login              â”‚                        â”‚
```

**Nota:** Para multi-tab sync completo, considerar `BroadcastChannel` API (opcional, P2).

---

## 15. Diagrama de Performance: OptimizaciÃ³n de Queries

### ANTES (MÃºltiples Queries)

```
Request 1: GET /session/me
    â””â”€> Query User
    â””â”€> Query TenantMembership
    â””â”€> Query Tenant
    â””â”€> Return (150ms)

Request 2: GET /session/me (duplicado)
    â””â”€> Query User
    â””â”€> Query TenantMembership
    â””â”€> Query Tenant
    â””â”€> Return (150ms)

Request 3: GET /session/me (duplicado)
    â””â”€> Query User
    â””â”€> Query TenantMembership
    â””â”€> Query Tenant
    â””â”€> Return (150ms)

Total: 450ms + overhead
```

### DESPUÃ‰S (Single-Flight + Cache)

```
Request 1: GET /session/me
    â””â”€> Query User
    â””â”€> Query TenantMembership
    â””â”€> Query Tenant
    â””â”€> Return (150ms)
    â””â”€> Cache (5 min)

Request 2: GET /session/me (deduplicado)
    â””â”€> Espera resultado de Request 1
    â””â”€> Return cached (0ms)

Request 3: GET /session/me (deduplicado)
    â””â”€> Espera resultado de Request 1
    â””â”€> Return cached (0ms)

Total: 150ms (93% mejora)
```

---

## 16. Diagrama de Testing: Estrategia Completa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Testing Pyramid                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚   E2E     â”‚  (10%)                  â”‚
â”‚                    â”‚  Tests    â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                         â”‚                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚Integrationâ”‚  (30%)                  â”‚
â”‚                    â”‚  Tests    â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                         â”‚                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚   Unit    â”‚  (60%)                  â”‚
â”‚                    â”‚  Tests    â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                           â”‚
â”‚  Coverage: >90%                                           â”‚
â”‚  - AuthManager: 100%                                      â”‚
â”‚  - Mutex: 100%                                            â”‚
â”‚  - ApiClient: >85%                                        â”‚
â”‚  - Components: >80%                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 17. Diagrama de Rollout: Estrategia de Despliegue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Rollout Strategy                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Fase 1: Feature Flag OFF                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ - Implementar AuthManager                       â”‚   â”‚
â”‚  â”‚ - Implementar Mutex                             â”‚   â”‚
â”‚  â”‚ - Testing exhaustivo                            â”‚   â”‚
â”‚  â”‚ - Code review                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â–¼                                  â”‚
â”‚  Fase 2: Feature Flag ON (10% usuarios)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ - Monitorear mÃ©tricas                            â”‚   â”‚
â”‚  â”‚ - Validar performance                            â”‚   â”‚
â”‚  â”‚ - Verificar logs                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â–¼                                  â”‚
â”‚  Fase 3: Feature Flag ON (50% usuarios)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ - Monitorear mÃ©tricas                            â”‚   â”‚
â”‚  â”‚ - Comparar con baseline                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â–¼                                  â”‚
â”‚  Fase 4: Feature Flag ON (100% usuarios)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ - Remover cÃ³digo antiguo                        â”‚   â”‚
â”‚  â”‚ - Cleanup                                       â”‚   â”‚
â”‚  â”‚ - DocumentaciÃ³n final                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  Rollback Plan:                                           â”‚
â”‚  - Feature flag OFF inmediato                            â”‚
â”‚  - CÃ³digo antiguo sigue disponible                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 18. Diagrama de MÃ©tricas: Dashboard de Observabilidad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Auth Metrics Dashboard                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Bootstrap    â”‚  â”‚ Refresh      â”‚  â”‚ Logout      â”‚  â”‚
â”‚  â”‚ Count: 1     â”‚  â”‚ Count: 0     â”‚  â”‚ Count: 0     â”‚  â”‚
â”‚  â”‚ Time: 150ms  â”‚  â”‚ Time: N/A   â”‚  â”‚ Time: N/A   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cache Hit    â”‚  â”‚ Cache Miss   â”‚  â”‚ Error 401    â”‚  â”‚
â”‚  â”‚ Rate: 85%    â”‚  â”‚ Rate: 15%    â”‚  â”‚ Rate: 0.5%   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Error 403    â”‚  â”‚ Error 429    â”‚  â”‚ Refresh      â”‚  â”‚
â”‚  â”‚ Rate: 1.2%   â”‚  â”‚ Rate: 0.1%   â”‚  â”‚ Loops: 0     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  Alerts:                                                  â”‚
â”‚  âœ… All metrics within target                            â”‚
â”‚  âœ… No refresh loops detected                            â”‚
â”‚  âœ… Performance within SLA                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Estos diagramas complementan el AI-Spec principal y proporcionan visualizaciones detalladas de todos los flujos crÃ­ticos.**


