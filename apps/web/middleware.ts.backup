import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

/**
 * Middleware de seguridad para Next.js
 * Aplica validaciones de seguridad especialmente para ngrok
 * 
 * ⚠️ BACKUP - Versión original guardada para restaurar después de pruebas
 */

export function middleware(request: NextRequest) {
  const hostname = request.headers.get('host') || '';
  const isNgrok = hostname.includes('ngrok') || 
                  hostname.includes('ngrok-free') || 
                  hostname.includes('ngrok.io');
  
  // Si estamos usando ngrok, aplicar validaciones de seguridad
  if (isNgrok) {
    // Verificar autenticación básica si está configurada
    const authUser = process.env.NGROK_AUTH_USER;
    const authPass = process.env.NGROK_AUTH_PASS;
    
    if (authUser && authPass) {
      const authHeader = request.headers.get('authorization');
      
      if (!authHeader || !authHeader.startsWith('Basic ')) {
        return new NextResponse('Autenticación requerida', {
          status: 401,
          headers: {
            'WWW-Authenticate': 'Basic realm="Acceso restringido - Desarrollo"',
          },
        });
      }
      
      // Decodificar y verificar credenciales
      const credentials = Buffer.from(authHeader.substring(6), 'base64').toString('utf-8');
      const [user, pass] = credentials.split(':');
      
      if (user !== authUser || pass !== authPass) {
        return new NextResponse('Credenciales inválidas', {
          status: 401,
          headers: {
            'WWW-Authenticate': 'Basic realm="Acceso restringido - Desarrollo"',
          },
        });
      }
    }
    
    // Verificar lista blanca de IPs si está configurada
    const allowedIPs = process.env.NGROK_ALLOWED_IPS?.split(',').map(ip => ip.trim());
    if (allowedIPs && allowedIPs.length > 0) {
      const clientIP = request.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ||
                      request.headers.get('x-real-ip') ||
                      request.ip ||
                      'unknown';
      
      if (!allowedIPs.includes(clientIP) && !allowedIPs.includes('*')) {
        return new NextResponse('Acceso denegado - IP no autorizada', {
          status: 403,
        });
      }
    }
    
    // Agregar headers de seguridad adicionales para ngrok
    const response = NextResponse.next();
    response.headers.set('X-Environment', 'development-ngrok');
    response.headers.set('X-Security-Warning', 'Este es un entorno de desarrollo expuesto públicamente');
    
    return response;
  }
  
  // Para producción, aplicar headers de seguridad estándar
  if (process.env.NODE_ENV === 'production') {
    const response = NextResponse.next();
    response.headers.set('X-Environment', 'production');
    return response;
  }
  
  return NextResponse.next();
}

// Configurar en qué rutas aplicar el middleware
export const config = {
  matcher: [
    /*
     * Aplicar a todas las rutas excepto:
     * - api (ya tiene su propia seguridad)
     * - _next/static (archivos estáticos)
     * - _next/image (optimización de imágenes)
     * - favicon.ico (favicon)
     */
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
};


